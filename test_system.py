"""
AdMorph.AI System Tests
Basic validation and testing suite
"""

import asyncio
import sys
import os
import json
from datetime import datetime
from typing import Dict, List, Any

# Add current directory to path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

def test_imports():
    """Test that all modules can be imported"""
    
    print("üß™ Testing imports...")
    
    try:
        from admorph_core import (
            BusinessProfile, AdVariantMorph, DemographicSegment,
            AdMorphVoiceAgent, DemographicAnalysisAgent, AdVariantGenerationAgent
        )
        print("‚úÖ admorph_core imports successful")
    except Exception as e:
        print(f"‚ùå admorph_core import failed: {e}")
        return False
    
    try:
        from swipe_interface import TinderStyleAdReviewer
        print("‚úÖ swipe_interface imports successful")
    except Exception as e:
        print(f"‚ùå swipe_interface import failed: {e}")
        return False
    
    try:
        from meta_api_integration import MetaMarketingAPIClient, AdMorphCampaignManager
        print("‚úÖ meta_api_integration imports successful")
    except Exception as e:
        print(f"‚ùå meta_api_integration import failed: {e}")
        return False
    
    try:
        from agentic_evolution import EvolutionOrchestrator, EvolutionMonitor
        print("‚úÖ agentic_evolution imports successful")
    except Exception as e:
        print(f"‚ùå agentic_evolution import failed: {e}")
        return False
    
    try:
        from coee import AIAdvertisingAgency, AdMorphIntegratedOrchestrator
        print("‚úÖ coee imports successful")
    except Exception as e:
        print(f"‚ùå coee import failed: {e}")
        return False
    
    return True

def test_environment():
    """Test environment configuration"""
    
    print("\nüîß Testing environment configuration...")
    
    # Check for .env file
    if os.path.exists('.env'):
        print("‚úÖ .env file found")
    else:
        print("‚ö†Ô∏è .env file not found (using .env.example)")
    
    # Check API keys
    openai_key = os.getenv("OPENAI_API_KEY")
    meta_token = os.getenv("META_ACCESS_TOKEN")
    
    if openai_key:
        print("‚úÖ OpenAI API key configured")
    else:
        print("‚ö†Ô∏è OpenAI API key not configured")
    
    if meta_token:
        print("‚úÖ Meta API token configured")
    else:
        print("‚ö†Ô∏è Meta API token not configured")
    
    return True

async def test_voice_agent():
    """Test voice agent functionality"""
    
    print("\nüé§ Testing Voice Agent...")
    
    try:
        from admorph_core import AdMorphVoiceAgent
        
        agent = AdMorphVoiceAgent()
        
        # Test start onboarding
        result = await agent.execute({"stage": "start"})
        
        if "message" in result and "stage" in result:
            print("‚úÖ Voice agent onboarding start successful")
            return True
        else:
            print("‚ùå Voice agent returned unexpected format")
            return False
            
    except Exception as e:
        print(f"‚ùå Voice agent test failed: {e}")
        return False

async def test_demographic_agent():
    """Test demographic analysis agent"""
    
    print("\nüéØ Testing Demographic Agent...")
    
    try:
        from admorph_core import DemographicAnalysisAgent, BusinessProfile
        
        agent = DemographicAnalysisAgent()
        
        # Create test business profile
        test_profile = BusinessProfile(
            business_id="test_123",
            business_name="Test Business",
            industry="Technology",
            target_engagement="sales",
            monthly_budget=5000.0,
            target_audience={"description": "Tech professionals"},
            brand_themes={"allowed": ["innovation"], "disallowed": []},
            original_ad_assets=[],
            voice_preferences={},
            created_at=datetime.now().isoformat(),
            updated_at=datetime.now().isoformat()
        )
        
        result = await agent.execute(test_profile)
        
        if "demographic_segments" in result and len(result["demographic_segments"]) > 0:
            print(f"‚úÖ Demographic agent created {len(result['demographic_segments'])} segments")
            return True
        else:
            print("‚ùå Demographic agent failed to create segments")
            return False
            
    except Exception as e:
        print(f"‚ùå Demographic agent test failed: {e}")
        return False

async def test_variant_generator():
    """Test ad variant generation"""
    
    print("\nüé® Testing Variant Generator...")
    
    try:
        from admorph_core import AdVariantGenerationAgent, BusinessProfile, DemographicSegment
        
        agent = AdVariantGenerationAgent()
        
        # Create test data
        test_profile = BusinessProfile(
            business_id="test_123",
            business_name="Test Business",
            industry="Technology",
            target_engagement="sales",
            monthly_budget=5000.0,
            target_audience={"description": "Tech professionals"},
            brand_themes={"allowed": ["innovation"], "disallowed": []},
            original_ad_assets=[],
            voice_preferences={},
            created_at=datetime.now().isoformat(),
            updated_at=datetime.now().isoformat()
        )
        
        test_segment = DemographicSegment(
            segment_id="test_segment",
            name="Test Segment",
            age_range=(25, 40),
            gender="all",
            interests=["Technology"],
            behaviors=["Early adopters"],
            location="United States",
            income_level="Middle",
            education="Bachelor's",
            meta_targeting_spec={}
        )
        
        result = await agent.execute(test_profile, [test_segment])
        
        if "variants" in result and len(result["variants"]) > 0:
            print(f"‚úÖ Variant generator created {len(result['variants'])} variants")
            return True
        else:
            print("‚ùå Variant generator failed to create variants")
            return False
            
    except Exception as e:
        print(f"‚ùå Variant generator test failed: {e}")
        return False

async def test_evolution_system():
    """Test agentic evolution system"""
    
    print("\nüß¨ Testing Evolution System...")
    
    try:
        from agentic_evolution import SyntheticDataGenerator, TrendAnalysisAgent
        from admorph_core import BusinessProfile
        
        # Test synthetic data generation
        data_gen = SyntheticDataGenerator()
        trends = data_gen.generate_trend_data()
        
        if len(trends) > 0:
            print(f"‚úÖ Generated {len(trends)} trend data points")
        else:
            print("‚ùå Failed to generate trend data")
            return False
        
        # Test trend analysis
        trend_agent = TrendAnalysisAgent()
        test_profile = BusinessProfile(
            business_id="test_123",
            business_name="Test Business",
            industry="Technology",
            target_engagement="sales",
            monthly_budget=5000.0,
            target_audience={"description": "Tech professionals"},
            brand_themes={"allowed": ["innovation"], "disallowed": []},
            original_ad_assets=[],
            voice_preferences={},
            created_at=datetime.now().isoformat(),
            updated_at=datetime.now().isoformat()
        )
        
        result = await trend_agent.execute(test_profile, trends)
        
        if "relevant_trends" in result:
            print(f"‚úÖ Trend analysis identified {len(result['relevant_trends'])} relevant trends")
            return True
        else:
            print("‚ùå Trend analysis failed")
            return False
            
    except Exception as e:
        print(f"‚ùå Evolution system test failed: {e}")
        return False

def test_data_models():
    """Test data model creation"""
    
    print("\nüìä Testing Data Models...")
    
    try:
        from admorph_core import BusinessProfile, AdVariantMorph, DemographicSegment
        
        # Test BusinessProfile
        profile = BusinessProfile(
            business_id="test_123",
            business_name="Test Business",
            industry="Technology",
            target_engagement="sales",
            monthly_budget=5000.0,
            target_audience={"description": "Tech professionals"},
            brand_themes={"allowed": ["innovation"], "disallowed": []},
            original_ad_assets=[],
            voice_preferences={},
            created_at=datetime.now().isoformat(),
            updated_at=datetime.now().isoformat()
        )
        print("‚úÖ BusinessProfile creation successful")
        
        # Test DemographicSegment
        segment = DemographicSegment(
            segment_id="test_segment",
            name="Test Segment",
            age_range=(25, 40),
            gender="all",
            interests=["Technology"],
            behaviors=["Early adopters"],
            location="United States",
            income_level="Middle",
            education="Bachelor's",
            meta_targeting_spec={}
        )
        print("‚úÖ DemographicSegment creation successful")
        
        # Test AdVariantMorph
        variant = AdVariantMorph(
            variant_id="test_variant",
            headline="Test Headline",
            body="Test body copy",
            cta="Test CTA",
            image_url="",
            aesthetic_score=0.8,
            ogilvy_score=0.8,
            emotional_impact=0.8,
            format_type="social",
            demographic_segment=segment,
            generation_strategy="test",
            mutation_history=[],
            performance_score=0.0,
            trend_alignment=0.0,
            swipe_status="pending"
        )
        print("‚úÖ AdVariantMorph creation successful")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Data model test failed: {e}")
        return False

async def run_all_tests():
    """Run all system tests"""
    
    print("üéØ AdMorph.AI System Tests")
    print("=" * 50)
    
    tests = [
        ("Import Tests", test_imports),
        ("Environment Tests", test_environment),
        ("Data Model Tests", test_data_models),
        ("Voice Agent Tests", test_voice_agent),
        ("Demographic Agent Tests", test_demographic_agent),
        ("Variant Generator Tests", test_variant_generator),
        ("Evolution System Tests", test_evolution_system)
    ]
    
    results = []
    
    for test_name, test_func in tests:
        try:
            if asyncio.iscoroutinefunction(test_func):
                result = await test_func()
            else:
                result = test_func()
            results.append((test_name, result))
        except Exception as e:
            print(f"‚ùå {test_name} failed with exception: {e}")
            results.append((test_name, False))
    
    # Summary
    print("\n" + "=" * 50)
    print("üìã Test Summary")
    print("=" * 50)
    
    passed = 0
    total = len(results)
    
    for test_name, result in results:
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"{status} - {test_name}")
        if result:
            passed += 1
    
    print(f"\nüéØ Results: {passed}/{total} tests passed")
    
    if passed == total:
        print("üéâ All tests passed! System is ready to use.")
    else:
        print("‚ö†Ô∏è Some tests failed. Check configuration and dependencies.")
    
    return passed == total

if __name__ == "__main__":
    print("üß™ Starting AdMorph.AI System Tests...")
    
    try:
        success = asyncio.run(run_all_tests())
        sys.exit(0 if success else 1)
    except KeyboardInterrupt:
        print("\nüëã Tests interrupted by user")
        sys.exit(1)
    except Exception as e:
        print(f"\n‚ùå Test runner failed: {e}")
        sys.exit(1)
